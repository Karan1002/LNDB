<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Current Account Application Submitted</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f8fb;
            color: #004a8f;
            max-width: 820px;
            margin: 28px auto;
            padding: 22px;
        }

        h1 {
            text-align: center;
            color: #003380;
            margin-bottom: 6px;
        }

        .ref-box {
            text-align: center;
            background-color: white;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 12px auto 18px;
            box-shadow: 0 2px 10px rgba(0, 74, 143, 0.08);
            font-weight: 700;
            color: #0d6efd;
            font-size: 1.15rem;
            width: fit-content;
        }

        p {
            text-align: center;
            font-size: 1rem;
            margin-bottom: 14px;
            color: #233;
        }

        ul {
            background: white;
            padding: 16px 18px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 74, 143, 0.06);
            margin-bottom: 18px;
        }

        ul li {
            margin: 8px 0;
            font-size: 0.98rem;
            color: #333;
        }

        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 18px;
        }

        button,
        .btn {
            padding: 10px 18px;
            font-size: 15px;
            background-color: #0d6efd;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        button.secondary {
            background: #6c757d;
        }

        .footer {
            text-align: center;
            font-size: 0.9rem;
            margin-top: 22px;
            color: #555;
        }

        .small {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }
    </style>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
    <h1>Your Current Account Application Has Been Submitted!</h1>

    <div class="ref-box">
        Reference No: <span id="refNo">CA000000</span>
    </div>

    <p>Thank you for choosing CRB for your business banking. Please take the printed PDF and the original documents to
        your nearest branch.</p>

    <ul>
        <li>Business Registration Certificate</li>
        <li>PAN Card of Proprietor / Firm</li>
        <li>Address Proof of Business</li>
        <li>GST Certificate (if applicable)</li>
        <li>Photograph & Signature of Authorized Signatory</li>
    </ul>

    <div class="controls">
        <button id="downloadPDF">Download Application PDF</button>
        <button class="secondary" id="returnHome">Return to Home</button>
    </div>

    <div class="small">PDF will include full application details, uploaded images (if small enough), signature boxes and
        a branch-use page.</div>

    <div class="footer">© 2025 CapitalRise Bank (CRB)— All Rights Reserved.</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        (function () {
            const refEl = document.getElementById('refNo');
            const savedRef = localStorage.getItem("latestCurrentRef");

            // ✅ DISPLAY REFERENCE
            refEl.textContent = savedRef || "Unavailable";

            // ✅ FIXED: Get FULL application data (not admin summary)
            function getFullRecordByRef(ref) {
                try {
                    // First try full applications
                    let apps = JSON.parse(localStorage.getItem("currentAccountApplications") || "[]");
                    let fullRecord = apps.find(r => r.refNo === ref) || apps[apps.length - 1];

                    if (fullRecord) return fullRecord;

                    // Fallback to admin summary
                    const list = JSON.parse(localStorage.getItem("lndbCurrentAccounts") || "[]");
                    return list.find(r => r.refNo === ref) || list[list.length - 1] || {};
                } catch (e) {
                    console.error("Error getting record:", e);
                    return {};
                }
            }

            async function buildAndDownloadPDF() {
                const ref = savedRef || ("CA" + Math.floor(100000 + Math.random() * 900000));
                const record = getFullRecordByRef(ref) || {};
                const { jsPDF } = window.jspdf;

                const pdf = new jsPDF("p", "mm", "a4");
                let y = 15;

                // ✅ EXTRACT ALL FIELDS CORRECTLY
                const personal = record.personal || {};
                const businessData = record.businessData || {};
                const address = record.address || {};
                const contact = record.contact || {};
                const authSignatory = record.authSignatory || {};

                // Helpers
                function sectionTitle(title) {
                    if (y > 270) { pdf.addPage(); y = 15; }
                    pdf.setFillColor(35, 107, 189);
                    pdf.setTextColor(255, 255, 255);
                    pdf.rect(10, y, 190, 8, "F");
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(12);
                    pdf.text(title, 14, y + 5);
                    y += 12;
                    pdf.setTextColor(0, 0, 0);
                }

                function addField(title, value) {
                    if (y > 270) { pdf.addPage(); y = 15; }
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(10);
                    pdf.text(title, 14, y);
                    pdf.setFont("helvetica", "normal");
                    pdf.text(":", 60, y);
                    pdf.text(value ? String(value) : "N/A", 65, y);
                    y += 8;
                    pdf.setDrawColor(200, 200, 200);
                    pdf.line(10, y, 200, y);
                    y += 3;
                }

                // HEADER
                pdf.setFont("helvetica", "bold");
                pdf.setFontSize(16);
                pdf.text("LENA DENA BANK (LNDB)", 105, y, null, null, "center");
                y += 7;
                pdf.setFontSize(12);
                pdf.text("Current Account Opening Form", 105, y, null, null, "center");
                y += 10;

                // REFERENCE
                addField("Reference Number", ref);
                addField("Application Date", new Date().toLocaleDateString());

                // APPLICANT DETAILS
                sectionTitle("Applicant Details");
                addField("Full Name", personal.fullName || personal.name);
                addField("Father/Spouse Name", personal.fatherName);
                addField("Date of Birth", personal.dob);
                addField("Personal PAN", personal.pan);
                const aadhaarMasked = personal.aadhaar ? "XXXX XXXX " + (personal.aadhaar.slice ? personal.aadhaar.slice(-4) : "****") : "N/A";
                addField("Aadhaar", aadhaarMasked);

                // BUSINESS DETAILS
                sectionTitle("Business Details");
                addField("Business Name", businessData.businessName);
                addField("Business Type", businessData.businessType);
                addField("Registration Number", businessData.registrationNumber);
                addField("GST Number", businessData.gstNumber || "N/A");
                addField("Company PAN", businessData.panCompany);

                // CONTACT DETAILS
                sectionTitle("Contact Details");
                addField("Primary Phone", contact.phone);
                addField("Primary Email", contact.email);
                addField("Website", contact.website || "N/A");

                // REGISTERED ADDRESS
                sectionTitle("Registered Address");
                addField("Address", address.address);
                addField("State", address.state);
                addField("District", address.district);
                addField("City", address.city);
                addField("Pincode", address.pincode);

                // AUTHORIZED SIGNATORY
                sectionTitle("Authorized Signatory");
                addField("Name", authSignatory.name);
                addField("Designation", authSignatory.designation);
                addField("Mobile", authSignatory.mobile);
                addField("Email", authSignatory.email);

                // BRANCH USE
                sectionTitle("For Branch Use Only");
                addField("Account Number", "________________");
                addField("Employee Code", "________________");
                y += 4;
                pdf.setFont("helvetica", "normal");
                pdf.text("Branch Seal & Date: ___________________________", 14, y);

                // DECLARATION
                if (y > 250) { pdf.addPage(); y = 15; }
                sectionTitle("Declaration");
                pdf.setFontSize(9);
                pdf.text("• I/We declare that all information provided is true and correct.", 14, y); y += 5;
                pdf.text("• I/We agree to LNDB terms & conditions for current account.", 14, y); y += 5;
                pdf.text("• Original documents will be presented at branch verification.", 14, y); y += 10;

                // SIGNATURES
                if (y > 230) { pdf.addPage(); y = 15; }
                pdf.setDrawColor(0, 0, 0);
                pdf.rect(145, y, 50, 50);
                pdf.setFontSize(8);
                pdf.text("Applicant Photo", 150, y + 25);
                pdf.rect(14, y + 55, 60, 20);
                pdf.text("Applicant Signature", 16, y + 68);
                pdf.rect(130, y + 55, 60, 20);
                pdf.text("Bank Officer Signature", 132, y + 68);

                // FOOTER
                pdf.setFontSize(8);
                pdf.text("System Generated — Visit Branch with Original Documents", 105, 290, null, null, "center");

                // ✅ SAVE PDF TO ADMIN RECORD
                try {
                    let adminAccounts = JSON.parse(localStorage.getItem("lndbCurrentAccounts") || "[]");
                    const pdfBase64 = pdf.output('datauristring');
                    for (let i = 0; i < adminAccounts.length; i++) {
                        if (adminAccounts[i].refNo === ref) {
                            adminAccounts[i].pdfFile = pdfBase64;
                            break;
                        }
                    }
                    localStorage.setItem("lndbCurrentAccounts", JSON.stringify(adminAccounts));
                } catch (e) {
                    console.log("PDF save to admin failed:", e);
                }

                pdf.save(`LNDB_Current_Account_${ref}.pdf`);
            }

            // BUTTON EVENT
            document.getElementById("downloadPDF").addEventListener("click", async function () {
                this.disabled = true;
                this.textContent = "Generating PDF... ⏳";
                await buildAndDownloadPDF();
                this.disabled = false;
                this.textContent = "Download Application PDF";
            });

            document.getElementById("returnHome").onclick = () => {
                window.location.href = 'index.html';
            };

            // ✅ DEBUG INFO
            console.log("✅ Current Account PDF Ready. Ref:", savedRef);
            console.log("Full Record:", getFullRecordByRef(savedRef));
        })();
    </script>


</body>

</html>