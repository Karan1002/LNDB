<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Credit Card Application Form</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f5f7fb;
            margin: 0;
            padding: 30px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .form-container {
            width: 100%;
            max-width: 500px;
            background: #fff;
            padding: 35px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
        }

        label {
            display: block;
            margin: 12px 0 6px;
            font-weight: 600;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #cfd5de;
            border-radius: 7px;
            background: #fafafa;
        }

        button {
            margin-top: 25px;
            width: 100%;
            padding: 14px 0;
            background: #236bbd;
            color: #fff;
            border: none;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
        }

        .error-message {
            color: red;
            font-size: 13px;
            display: none;
        }

        #cardLimit {
            background: #e8eef6;
        }
    </style>
</head>

<body>
    <div class="form-container">
        <h2 style="text-align:center;color:#236bbd">Credit Card Application</h2>

        <form id="creditCardForm">

            <label>Account Number</label>
            <input type="text" id="accountNumber">
            <div class="error-message" id="accountNumberError">Minimum 8 digits</div>

            <label>Full Name</label>
            <input type="text" id="fullname">
            <div class="error-message" id="fullnameError">Required</div>

            <label>Date of Birth</label>
            <input type="date" id="dob">
            <div class="error-message" id="dobError">Must be 18+</div>

            <label>Email</label>
            <input type="email" id="email">
            <div class="error-message" id="emailError">Invalid Email</div>

            <label>Phone</label>
            <input type="text" id="phone">
            <div class="error-message" id="phoneError">Enter 10 digit number</div>

            <label>Address</label>
            <input type="text" id="address">
            <div class="error-message" id="addressError">Required</div>

            <label>Monthly Income (INR)</label>
            <input type="number" id="income">
            <div class="error-message" id="incomeError">Enter valid income</div>

            <label>Card Type</label>
            <select id="cardType">
                <option value="">Select Card</option>
                <option value="Classic">Classic Card</option>
                <option value="Gold">Gold Card</option>
                <option value="Platinum">Platinum Card</option>
                <option value="Elite">Elite Card</option>
            </select>
            <div class="error-message" id="cardTypeError">Required</div>

            <label>Estimated Annual Limit</label>
            <input type="text" id="cardLimit" readonly>

            <label>PAN Number</label>
            <input type="text" id="pan" maxlength="10">
            <div class="error-message" id="panError">Invalid PAN</div>

            <label>Aadhaar (optional)</label>
            <input type="text" id="aadhaar" maxlength="12">
            <div class="error-message" id="aadhaarError">Must be 12 digits</div>

            <label>Upload ID Proof (JPG/PNG/PDF)</label>
            <input type="file" id="idProof" accept=".jpg,.jpeg,.png,.pdf">
            <div class="error-message" id="idProofError">Upload required</div>

            <div style="margin-top:15px;">
                <input type="checkbox" id="terms">
                <label>I accept Terms</label>
            </div>
            <div class="error-message" id="termsError">Required</div>

            <button type="submit">Apply Now</button>
        </form>
    </div>

    <script>
        // ‚úÖ Credit Card Backend Integration + Limit Calculator + FIXED URL

        const limitMultiplier = { Classic: 10, Gold: 15, Platinum: 20, Elite: 30 };

        function generateRefNo() {
            return "CC" + Math.floor(100000 + Math.random() * 900000);
        }

        function q(id) { return document.getElementById(id); }
        function showToast(msg, type = 'info') {
            const toast = document.createElement('div');
            toast.textContent = msg;
            toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; padding: 15px; 
        background: ${type === 'error' ? '#dc3545' : '#28a745'}; 
        color: white; border-radius: 5px; z-index: 9999; font-family: Arial;
    `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // ‚úÖ Limit Calculator
        const income = q("income");
        const cardType = q("cardType");
        const cardLimit = q("cardLimit");

        if (income && cardType && cardLimit) {
            income.oninput = cardType.onchange = () => {
                const val = Number(income.value);
                const type = cardType.value;
                cardLimit.value = (val && type) ? (val * limitMultiplier[type]).toLocaleString() : "";
            };
        }

        // ‚úÖ Backend Submit Handler
        document.addEventListener('DOMContentLoaded', function () {
            const form = q("creditCardForm");
            if (!form) {
                console.error('‚ùå Form not found: creditCardForm');
                return;
            }

            form.onsubmit = async function (e) {
                e.preventDefault();

                // ‚úÖ 1. Hide all errors
                document.querySelectorAll(".error-message").forEach(x => x.style.display = "none");

                // ‚úÖ 2. Get form values
                const accountNumber = q("accountNumber");
                const fullname = q("fullname");
                const dob = q("dob");
                const email = q("email");
                const phone = q("phone");
                const address = q("address");
                const incomeField = q("income");
                const cardTypeField = q("cardType");
                const pan = q("pan");
                const aadhaar = q("aadhaar");
                const idProof = q("idProof");
                const terms = q("terms");

                let ok = true;

                // ‚úÖ 3. VALIDATIONS (Same)
                const phoneReg = /^[0-9]{10}$/;
                const panReg = /^[A-Z]{5}[0-9]{4}[A-Z]$/;
                const accountReg = /^[0-9]{12}$/;

                if (!accountReg.test(accountNumber.value)) {
                    q('accountNumberError').textContent = "Account Number must be 12 digits";
                    q('accountNumberError').style.display = "block";
                    ok = false;
                }

                if (!fullname.value) { q('fullnameError').style.display = "block"; ok = false; }
                if (!dob.value) { q('dobError').style.display = "block"; ok = false; }
                if (!email.value) { q('emailError').style.display = "block"; ok = false; }

                if (!phoneReg.test(phone.value)) {
                    q('phoneError').textContent = "Phone Number must be 10 digits";
                    q('phoneError').style.display = "block";
                    ok = false;
                }

                if (!address.value) { q('addressError').style.display = "block"; ok = false; }
                if (!incomeField.value || incomeField.value <= 0) { q('incomeError').style.display = "block"; ok = false; }
                if (!cardTypeField.value) { q('cardTypeError').style.display = "block"; ok = false; }

                if (!panReg.test(pan.value)) {
                    q('panError').style.display = "block";
                    ok = false;
                }

                if (aadhaar.value && !/^\d{12}$/.test(aadhaar.value)) {
                    q('aadhaarError').textContent = "Aadhaar must be 12 digits";
                    q('aadhaarError').style.display = "block";
                    ok = false;
                }

                if (!idProof.files.length) { q('idProofError').style.display = "block"; ok = false; }
                if (!terms.checked) { q('termsError').style.display = "block"; ok = false; }

                // ‚úÖ Age validation
                if (dob.value) {
                    const birthDate = new Date(dob.value);
                    const ageDiff = Date.now() - birthDate.getTime();
                    const age = new Date(ageDiff).getUTCFullYear() - 1970;
                    if (age < 18) {
                        showToast("Must be 18+ for Credit Card!", 'error');
                        ok = false;
                    }
                }

                if (!ok) return;

                // ‚úÖ 4. Loading state
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn ? submitBtn.textContent : 'Submit';
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = '‚è≥ Submitting...';
                }

                try {
                    // ‚úÖ 5. Backend Data
                    const creditData = {
                        refNo: generateRefNo(),
                        accountNumber: accountNumber.value,
                        fullName: fullname.value,
                        dob: dob.value,
                        email: email.value,
                        phone: phone.value,
                        address: address.value,
                        income: Number(incomeField.value),
                        cardType: cardTypeField.value,
                        annualLimit: cardLimit.value.replace(/,/g, ''),
                        pan: pan.value.toUpperCase(),
                        aadhaar: aadhaar.value || '',
                        status: "pending",
                        applicationType: "creditCard"  // ‚Üê YE IMPORTANT!
                    };

                    console.log('üì§ Credit Card Data:', creditData);

                    // üî• ‚úÖ FIXED URL - SAME AS DEBIT CARD!
                    const response = await fetch('http://localhost:5000/api/cards/apply', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(creditData)
                    });

                    const responseText = await response.text();
                    console.log('üîç Response:', response.status, responseText.substring(0, 300));

                    if (!response.ok || responseText.includes('<!DOCTYPE') || responseText.includes('<html')) {
                        throw new Error(`Server Error ${response.status}`);
                    }

                    const result = JSON.parse(responseText);

                    if (result.success) {
                        localStorage.setItem("lastCreditRef", result.refNo || creditData.refNo);
                        localStorage.setItem("lastCreditData", JSON.stringify(creditData));
                        showToast(`üéâ SUCCESS! Ref: ${result.refNo || creditData.refNo}`, 'success');
                        setTimeout(() => window.location.href = "creditsub.html", 2000);
                    } else {
                        throw new Error(result.error || 'Failed');
                    }

                } catch (error) {
                    console.error('‚ùå Error:', error);
                    showToast(`‚ùå ${error.message}`, 'error');
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                }
            };
        });
    </script>


</body>

</html>