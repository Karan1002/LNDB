<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LNDB ‚Äî Admin Console (Redesigned)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
     <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ===== ENTERPRISE BANKING UI ‚Äî PREMIUM, CLEAN, SECURE ===== */

        :root {
            --bg: #f2f4f7;
            /* Professional soft gray */
            --card: #ffffff;
            --muted: #5f6b7c;
            --accent: #0a3d91;
            /* Banking blue */
            --accent-2: #0f67c0;
            --soft: #eef1f5;
            --border: #d7dbe2;
            --success: #0d7a45;
            --danger: #b91c1c;
            --radius: 10px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 8px 22px rgba(0, 0, 0, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body,
        html {
            margin: 0;
            height: 100%;
            background: var(--bg);
            font-family: "Inter", system-ui, sans-serif;
            color: #1a1f36;
        }

        /* ===== LAYOUT ===== */
        .app {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 28px;
            padding: 28px;
            min-height: 100vh;
        }

        .sidebar {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
        }

        .logo {
            width: 42px;
            height: 42px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .brand h1 {
            font-size: 15px;
            margin: 0;
            font-weight: 700;
            color: #1a1f36;
        }

        /* ===== NAVIGATION ===== */
        .nav button {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: transparent;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: var(--muted);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 6px;
            transition: all 0.15s ease;
        }

        .nav button.active {
            background: transparent !important;
            color: var(--muted) !important;
            font-weight: 600 !important;
            box-shadow: none !important;
        }

        .nav button:hover {
            background: rgba(0, 0, 0, 0.04);
            color: #1a1f36;
        }

        .nav button:active {
            transform: scale(0.97);
            background: rgba(10, 61, 145, 0.18);
            color: white;
            box-shadow: 0 0 0 3px rgba(10, 61, 145, 0.25);
        }

        .sidebar footer {
            font-size: 12px;
            margin-top: 20px;
            color: var(--muted);
        }

        /* ===== MAIN PANEL ===== */
        .main {
            background: var(--card);
            padding: 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        /* ===== SEARCH ===== */
        .search {
            display: flex;
            align-items: center;
            background: var(--soft);
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .search input {
            background: transparent;
            border: none;
            outline: none;
            flex: 1;
            font-size: 14px;
            color: #1a1f36;
        }

        /* ===== ACTION BUTTONS ===== */
        .btn {
            padding: 8px 14px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            border-radius: 8px;
            border: none;
            transition: all 0.15s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        }

        .btn:active {
            transform: scale(0.97);
            box-shadow: 0 0 0 3px rgba(10, 61, 145, 0.18);
        }

        .btn-ghost {
            background: #f5f7fa;
            border: 1px solid var(--border);
            color: #1a1f36;
        }

        .btn-ghost:hover {
            background: #eceff3;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            color: white;
            box-shadow: var(--shadow);
        }

        /* ===== METRIC CARDS ===== */
        .count-cards {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 14px;
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 16px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .card h4 {
            font-size: 12px;
            color: var(--muted);
        }

        .card .value {
            font-size: 24px;
            font-weight: 800;
            color: #1a1f36;
        }

        /* ===== TABS ===== */
        .tabs {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tabs button {
            padding: 8px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--soft);
            color: var(--muted);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tabs button:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        }

        .tabs button:active {
            transform: scale(0.97);
            box-shadow: 0 0 0 3px rgba(10, 61, 145, 0.18);
        }

        .tabs button.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            box-shadow: var(--shadow);
        }

        /* ===== TABLE ===== */
        .panel {
            background: var(--card);
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--border);
            margin-top: 16px;
        }

        .table-wrap {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        thead th {
            background: var(--soft);
            color: var(--muted);
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 700;
            text-align: left;
        }

        tbody td {
            padding: 12px;
            border-top: 1px solid var(--border);
            font-size: 14px;
            vertical-align: middle;
        }

        tbody tr:hover td {
            background: #f4f6fa;
        }

        .pill {
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
            text-align: center;
            min-width: 70px;
        }

        .pill.pending {
            background: #eef1f5;
            color: #5f6b7c;
        }

        .pill.accept {
            background: #d9f7e9;
            color: var(--success);
        }

        .pill.reject {
            background: #fde8e8;
            color: var(--danger);
        }

        .row-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .icon-btn {
            background: var(--soft);
            border: 1px solid var(--border);
            padding: 6px 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: #e8ecf2;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        }

        .icon-btn:active {
            transform: scale(0.97);
            box-shadow: 0 0 0 3px rgba(10, 61, 145, 0.18);
        }

        /* ===== RESPONSIVE ===== */
        @media(max-width:900px) {
            .app {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2;
            }

            .main {
                order: 1;
            }
        }

        @media(max-width:520px) {
            thead {
                display: none;
            }

            table,
            tbody,
            tr,
            td {
                display: block;
                width: 100%;
            }

            td {
                border-bottom: 1px solid var(--border);
                padding-left: 50%;
                position: relative;
            }

            td:before {
                content: attr(data-label);
                font-size: 12px;
                color: var(--muted);
                position: absolute;
                left: 16px;
                top: 12px;
                font-weight: 600;
            }

            .row-actions {
                justify-content: flex-start;
                gap: 6px;
            }
        }
    </style>



</head>

<body>
    <div class="app">
        <aside class="sidebar">
            <div class="brand">
                <div class="logo">LN</div>
                <div>
                    <h1>LNDB Admin</h1>
                    <div style="font-size:12px;color:var(--muted)">Control & approvals</div>
                </div>
            </div>

            <nav class="nav" id="mainNav">
                <button data-target="dashboard" class="active" onclick="switchSection(event)">üìä Dashboard</button>
                <button data-target="loanSection" onclick="switchSection(event)">üí∞ Loans</button>
                <button data-target="cardApplySection" onclick="switchSection(event)">üí≥ Cards</button>
                <button data-target="accountSection" onclick="switchSection(event)">üè¶ Accounts</button>
                <button data-target="investmentSection" onclick="switchSection(event)">üìà Investments</button>
            </nav>

            <div style="margin-top:18px">
                <div style="display:flex;gap:8px;margin-bottom:8px">
                    <button class="btn btn-ghost" id="logoutSmall" onclick="adminLogout()">Logout</button>
                </div>
                <footer>Version 2.0 ‚Äî LNDB ‚Ä¢ Secure</footer>
            </div>
        </aside>

        <main class="main">
            <div class="topbar">
                <div class="search">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:0.8;margin-left:4px">
                        <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round"></path>
                        <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round"></circle>
                    </svg>
                    <input id="searchInput" placeholder="Search by Ref / Name / Phone" oninput="searchAll(event)" />
                </div>
            </div>

            <!-- Dashboard -->
            <section id="dashboard" class="section-panel">
                <div class="count-cards" id="summaryCards">
                    <div class="card">
                        <h4>Pending Approvals</h4>
                        <div class="value" id="totalPending">0</div>
                        <div style="color:var(--muted);font-size:13px">All modules combined</div>
                    </div>
                    <div class="card">
                        <h4>Loans (Pending)</h4>
                        <div class="value" id="loanPendingCount">0</div>
                        <div style="color:var(--muted);font-size:13px">Business loans</div>
                    </div>
                    <div class="card">
                        <h4>Accounts (Pending)</h4>
                        <div class="value" id="accPendingCount">0</div>
                        <div style="color:var(--muted);font-size:13px">Savings / Current</div>
                    </div>
                    <div class="card">
                        <h4>Card Requests</h4>
                        <div class="value" id="cardPendingCount">0</div>
                        <div style="color:var(--muted);font-size:13px">Debit & Credit</div>
                    </div>
                </div>

                <div class="tabs" style="margin-top:22px">
                    <button class="active" onclick="focusModule('loanSection')">Loan Requests</button>
                    <button onclick="focusModule('cardApplySection')">Card Requests</button>
                    <button onclick="focusModule('accountSection')">Account Openings</button>
                    <button onclick="focusModule('investmentSection')">Investments</button>
                </div>

                <div class="panel" style="margin-top:14px">
                    <h3 style="margin:0 0 8px 0">Latest Pending ‚Äî Quick Actions</h3>
                    <div class="table-wrap">
                        <table id="quickTable">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Contact</th>
                                    <th>Amount</th>
                                    <th>Module</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Loans -->
            <section id="loanSection" class="section-panel" style="display:none">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
                    <h2 style="margin:0">Loan Requests</h2>
                    <div class="tabs">
                        <button class="active" onclick="showLoanSub('loanPending')">Pending</button>
                        <button onclick="showLoanSub('loanAccepted')">Accepted</button>
                        <button onclick="showLoanSub('loanRejected')">Rejected</button>
                    </div>
                </div>

                <div id="loanPendingPanel" class="panel" style="margin-top:12px">
                    <div class="table-wrap">
                        <table id="loanPendingTable">
                            <thead>
                                <tr>
                                    <th>Ref No</th>
                                    <th>Name</th>
                                    <th>Loan Type</th>
                                    <th>Phone</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="loanAcceptedPanel" class="panel" style="margin-top:12px;display:none">
                    <div class="table-wrap">
                        <table id="loanAcceptedTable">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Phone</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="loanRejectedPanel" class="panel" style="margin-top:12px;display:none">
                    <div class="table-wrap">
                        <table id="loanRejectedTable">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Phone</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Card Requests Section -->
            <section id="cardApplySection" class="section-panel" style="display:none">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
                    <h2 style="margin:0">Card Requests</h2>
                    <div class="tabs">
                        <button class="active" onclick="showCardSub('cardPendingPanel', this)">Pending</button>
                        <button onclick="showCardSub('cardAcceptedPanel', this)">Approved</button>
                        <button onclick="showCardSub('cardRejectedPanel', this)">Rejected</button>
                    </div>
                </div>

                <!-- Pending Cards -->
                <div id="cardPendingPanel" class="panel" style="margin-top:12px">
                    <div class="table-wrap">
                        <table id="cardPendingTable">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Name</th>
                                    <th>Acc No</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>DOB</th>
                                    <th>Type</th>
                                    <th>Limit</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Accepted Cards -->
                <div id="cardAcceptedPanel" class="panel" style="margin-top:12px; display:none">
                    <div class="table-wrap">
                        <table id="cardAcceptedTable">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Name</th>
                                    <th>Acc No</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>DOB</th>
                                    <th>Type</th>
                                    <th>Limit</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Rejected Cards -->
                <div id="cardRejectedPanel" class="panel" style="margin-top:12px; display:none">
                    <div class="table-wrap">
                        <table id="cardRejectedTable">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Name</th>
                                    <th>Acc No</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>DOB</th>
                                    <th>Type</th>
                                    <th>Limit</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Accounts -->
            <section id="accountSection" class="section-panel" style="display:none">

                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
                    <h2 style="margin:0">Accounts</h2>

                    <div class="tabs">
                        <button class="active" onclick="showAccTab('accPending', this)">Pending</button>
                        <button onclick="showAccTab('accAccepted', this)">Accepted</button>
                        <button onclick="showAccTab('accRejected', this)">Rejected</button>
                    </div>
                </div>

                <!-- Pending -->
                <div id="accPendingPanel" class="panel" style="margin-top:12px">
                    <div class="table-wrap">
                        <table id="accPendingTable">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Type</th>
                                    <th>PDF</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Accepted -->
                <div id="accAcceptedPanel" class="panel" style="margin-top:12px;display:none">
                    <div class="table-wrap">
                        <table id="accAcceptedTable">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Type</th>
                                    <th>PDF</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Rejected -->
                <div id="accRejectedPanel" class="panel" style="margin-top:12px;display:none">
                    <div class="table-wrap">
                        <table id="accRejectedTable">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Type</th>
                                    <th>PDF</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </section>


            <!-- Investments -->
            <section id="investmentSection" class="section-panel" style="display:none">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
                    <h2 style="margin:0">Investments</h2>
                    <div class="tabs">
                        <button class="active" onclick="showInvSub('invPending')">Pending</button>
                        <button onclick="showInvSub('invAccepted')">Accepted</button>
                        <button onclick="showInvSub('invRejected')">Rejected</button>
                    </div>
                </div>

                <div id="invPendingPanel" class="panel" style="margin-top:12px">
                    <div class="table-wrap">
                        <table id="invPendingTable">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Name</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="invAcceptedPanel" class="panel" style="margin-top:12px;display:none">
                    <div class="table-wrap">
                        <table id="invAcceptedTable">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Name</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="invRejectedPanel" class="panel" style="margin-top:12px;display:none">
                    <div class="table-wrap">
                        <table id="invRejectedTable">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Name</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <input type="file" id="exportBtn" style="display:none" />
        </main>
    </div>
    <script>
        /* ==========================================================
           UTILITIES
        ========================================================== */

        function escapeHtml(str = "") {
            if (!str) return "";
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showToast(msg) {
            const toast = document.getElementById("toast");
            if (toast) {
                toast.textContent = msg;
                toast.style.display = "block";
                setTimeout(() => (toast.style.display = "none"), 2500);
            }
        }

        /* ==========================================================
           SWITCH SECTIONS (Sidebar Navigation)
        ========================================================== */

        function switchSection(e) {
            const btn = e.target.closest('button');
            if (!btn) return;

            document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");

            const target = btn.getAttribute("data-target");

            document.querySelectorAll(".section-panel").forEach(s => (s.style.display = "none"));
            const targetEl = document.getElementById(target);
            if (targetEl) targetEl.style.display = "block";

            // Refresh data based on section
            if (target === "loanSection") loadLoans();
            if (target === "cardApplySection") loadCards();
            if (target === "accountSection") loadAccounts();
            if (target === "investmentSection") loadInvestments();
            if (target === "dashboard") refreshDashboard();
        }

        /* ==========================================================
           DASHBOARD SUMMARY + QUICK TABLE
        ========================================================== */

        function updateSummary() {
            const loans = JSON.parse(localStorage.getItem("lndbLoanApplications")) || [];
            const sav = JSON.parse(localStorage.getItem("lndbSavingAccounts")) || [];
            const cur = JSON.parse(localStorage.getItem("lndbCurrentAccounts")) || [];
            const deb = JSON.parse(localStorage.getItem("lndbApplications")) || [];
            const cred = JSON.parse(localStorage.getItem("lndbCreditCardApplications")) || [];

            const accounts = [...sav, ...cur];
            const cards = [...deb, ...cred];

            const pendingLoans = loans.filter(l => (l.status || "Pending") === "Pending").length;
            const pendingAcc = accounts.filter(a => (a.status || "Pending") === "Pending").length;
            const pendingCards = cards.filter(c => (c.status || "Pending") === "Pending").length;

            const loanPendingEl = document.getElementById("loanPendingCount");
            const accPendingEl = document.getElementById("accPendingCount");
            const cardPendingEl = document.getElementById("cardPendingCount");
            const totalPendingEl = document.getElementById("totalPending");

            if (loanPendingEl) loanPendingEl.textContent = pendingLoans;
            if (accPendingEl) accPendingEl.textContent = pendingAcc;
            if (cardPendingEl) cardPendingEl.textContent = pendingCards;
            if (totalPendingEl) totalPendingEl.textContent = pendingLoans + pendingAcc + pendingCards;
        }

        function populateQuick() {
            const tbody = document.querySelector("#quickTable tbody");
            if (!tbody) return;
            tbody.innerHTML = "";

            let combined = [];

            // Add Pending Loans
            const loans = JSON.parse(localStorage.getItem("lndbLoanApplications")) || [];
            loans.filter(l => (l.status || "Pending") === "Pending").forEach(l => {
                combined.push({ ref: l.refNo, name: l.name, type: l.loanType, contact: l.phone, amount: l.amount, module: "Loan" });
            });

            // Add Pending Accounts (Savings + Current)
            const sav = JSON.parse(localStorage.getItem("lndbSavingAccounts")) || [];
            const cur = JSON.parse(localStorage.getItem("lndbCurrentAccounts")) || [];
            [...sav, ...cur].filter(a => (a.status || "Pending") === "Pending").forEach(a => {
                combined.push({
                    ref: a.refNo,
                    name: a.name || a.fullName,
                    type: a.accountType || (a.refNo.startsWith('CA') ? "Current" : "Savings"),
                    contact: a.phone,
                    amount: "-",
                    module: "Account"
                });
            });

            combined.slice(0, 8).forEach(r => {
                tbody.insertAdjacentHTML("beforeend", `
            <tr>
                <td>${r.ref}</td>
                <td>${escapeHtml(r.name || "")}</td>
                <td>${escapeHtml(r.type || "")}</td>
                <td>${escapeHtml(r.contact || "")}</td>
                <td>${r.amount}</td>
                <td>${r.module}</td>
                <td><span class="pill pending">Pending</span></td>
            </tr>
        `);
            });
        }

        function refreshDashboard() {
            updateSummary();
            populateQuick();
        }

        /* ==========================================================
           LOANS (REF-BASED UPDATE)
        ========================================================== */

        function loadLoans() {
            const loans = JSON.parse(localStorage.getItem("lndbLoanApplications")) || [];
            const p = document.querySelector("#loanPendingTable tbody");
            const a = document.querySelector("#loanAcceptedTable tbody");
            const r = document.querySelector("#loanRejectedTable tbody");

            if (p) p.innerHTML = "";
            if (a) a.innerHTML = "";
            if (r) r.innerHTML = "";

            loans.forEach((l) => {
                const s = l.status || "Pending";
                const row = `
            <tr>
                <td>${l.refNo}</td>
                <td>${escapeHtml(l.name)}</td>
                <td>${escapeHtml(l.loanType)}</td>
                <td>${escapeHtml(l.phone)}</td>
                <td>${l.amount}</td>
                ${s === "Pending" ? `
                <td>
                    <div class='row-actions'>
                        <button class='icon-btn' onclick="updateLoan('${l.refNo}','Accepted')">‚úî</button>
                        <button class='icon-btn' onclick="updateLoan('${l.refNo}','Rejected')">‚úñ</button>
                    </div>
                </td>` : `<td><span class='pill ${s.toLowerCase()}'>${s}</span></td>`}
            </tr>`;

                if (s === "Pending" && p) p.insertAdjacentHTML("beforeend", row);
                if (s === "Accepted" && a) a.insertAdjacentHTML("beforeend", row);
                if (s === "Rejected" && r) r.insertAdjacentHTML("beforeend", row);
            });
            updateSummary();
        }

        function updateLoan(refNo, status) {
            let loans = JSON.parse(localStorage.getItem("lndbLoanApplications")) || [];
            const idx = loans.findIndex(l => l.refNo === refNo);
            if (idx >= 0) {
                loans[idx].status = status;
                localStorage.setItem("lndbLoanApplications", JSON.stringify(loans));
                loadLoans();
                populateQuick();
                showToast(`Loan ${refNo} updated to ${status}`);
            }
        }

        /* ==========================================================
           CARDS (REF-BASED UPDATE)
        ========================================================== */

        let allCards = [];

        function loadCards() {
            const debit = JSON.parse(localStorage.getItem("lndbApplications")) || [];
            const credit = JSON.parse(localStorage.getItem("lndbCreditCardApplications")) || [];
            allCards = [
                ...debit.map(d => ({ ...d, type: "Debit", limit: "-" })),
                ...credit.map(c => ({ ...c, type: "Credit", limit: c.annualLimit || "-" }))
            ];
            populateCardTables();
        }

        function populateCardTables() {
            const p = document.querySelector("#cardPendingTable tbody");
            const a = document.querySelector("#cardAcceptedTable tbody");
            const r = document.querySelector("#cardRejectedTable tbody");

            if (p) p.innerHTML = "";
            if (a) a.innerHTML = "";
            if (r) r.innerHTML = "";

            allCards.forEach((c) => {
                const s = c.status || "Pending";
                const row = `
            <tr>
                <td>${c.refNo || ""}</td>
                <td>${escapeHtml(c.name)}</td>
                <td>${escapeHtml(c.account || "")}</td>
                <td>${escapeHtml(c.phone || "")}</td>
                <td>${c.type}</td>
                <td>${c.limit}</td>
                ${s === "Pending" ? `
                <td>
                    <div class='row-actions'>
                        <button class='icon-btn' onclick="updateCard('${c.refNo}','${c.type}','Accepted')">‚úî</button>
                        <button class='icon-btn' onclick="updateCard('${c.refNo}','${c.type}','Rejected')">‚úñ</button>
                    </div>
                </td>` : `<td><span class="pill ${s.toLowerCase()}">${s}</span></td>`}
            </tr>`;

                if (s === "Pending" && p) p.insertAdjacentHTML("beforeend", row);
                if (s === "Accepted" && a) a.insertAdjacentHTML("beforeend", row);
                if (s === "Rejected" && r) r.insertAdjacentHTML("beforeend", row);
            });
            updateSummary();
        }

        function updateCard(refNo, cardType, status) {
            const key = cardType === "Debit" ? "lndbApplications" : "lndbCreditCardApplications";
            let arr = JSON.parse(localStorage.getItem(key)) || [];
            const idx = arr.findIndex(item => item.refNo === refNo);
            if (idx >= 0) {
                arr[idx].status = status;
                localStorage.setItem(key, JSON.stringify(arr));
                loadCards();
                populateQuick();
                showToast(`${cardType} Card ${refNo} ${status}`);
            }
        }

        /* ==========================================================
           ACCOUNTS (REF-BASED UPDATE)
        ========================================================== */

        let allAccounts = [];

        function loadAccounts() {
            const sav = JSON.parse(localStorage.getItem("lndbSavingAccounts")) || [];
            const cur = JSON.parse(localStorage.getItem("lndbCurrentAccounts")) || [];

            allAccounts = [
                ...sav.map(a => ({ ...a, type: a.Type || a.accountType || "Savings" })),
                ...cur.map(a => ({ ...a, type: a.Type || a.accountType || "Current" }))
            ].map(a => ({ ...a, status: a.status || "Pending" }));

            populateAccountTables();
        }

        function populateAccountTables() {
            const p = document.querySelector("#accPendingTable tbody");
            const a = document.querySelector("#accAcceptedTable tbody");
            const r = document.querySelector("#accRejectedTable tbody");

            if (p) p.innerHTML = "";
            if (a) a.innerHTML = "";
            if (r) r.innerHTML = "";

            allAccounts.forEach((acc) => {
                const st = acc.status;
                const pdf = acc.pdfFile ? `<a href="${acc.pdfFile}" target="_blank">üìÑ View</a>` : `<button class='btn btn-ghost' onclick="generatePDF('${acc.refNo}')">Generate</button>`;

                const row = `
            <tr>
                <td>${acc.refNo}</td>
                <td>${escapeHtml(acc.name || acc.fullName || "")}</td>
                <td>${escapeHtml(acc.phone || acc.mobile || "")}</td>
                <td>${acc.type}</td>
                <td>${pdf}</td>
                ${st === "Pending" ? `
                <td>
                    <div class='row-actions'>
                        <button class='icon-btn' onclick="updateAccount('${acc.refNo}','Accepted')">‚úî</button>
                        <button class='icon-btn' onclick="updateAccount('${acc.refNo}','Rejected')">‚úñ</button>
                    </div>
                </td>` : `<td><span class="pill ${st.toLowerCase()}">${st}</span></td>`}
            </tr>`;

                if (st === "Pending" && p) p.insertAdjacentHTML("beforeend", row);
                if (st === "Accepted" && a) a.insertAdjacentHTML("beforeend", row);
                if (st === "Rejected" && r) r.insertAdjacentHTML("beforeend", row);
            });
            updateSummary();
        }

        function updateAccount(refNo, status) {
            const key = refNo.startsWith('CA') ? "lndbCurrentAccounts" : "lndbSavingAccounts";
            let arr = JSON.parse(localStorage.getItem(key)) || [];
            const idx = arr.findIndex(a => a.refNo === refNo);
            if (idx >= 0) {
                arr[idx].status = status;
                localStorage.setItem(key, JSON.stringify(arr));
                loadAccounts();
                populateQuick();
                showToast(`Account ${refNo} ${status}`);
            }
        }

        /* ==========================================================
           INVESTMENTS (REF-BASED UPDATE)
        ========================================================== */

        function loadInvestments() {
            const inv = JSON.parse(localStorage.getItem("lndbInvestments")) || [];
            const p = document.querySelector("#invPendingTable tbody");
            const a = document.querySelector("#invAcceptedTable tbody");
            const r = document.querySelector("#invRejectedTable tbody");

            if (p) p.innerHTML = "";
            if (a) a.innerHTML = "";
            if (r) r.innerHTML = "";

            inv.forEach((x) => {
                const s = x.status || "Pending";
                const row = `
            <tr>
                <td>${x.refNo}</td>
                <td>${escapeHtml(x.name)}</td>
                <td>${x.amount}</td>
                ${s === "Pending" ? `
                <td>
                    <div class='row-actions'>
                        <button class='icon-btn' onclick="updateInv('${x.refNo}','Accepted')">‚úî</button>
                        <button class='icon-btn' onclick="updateInv('${x.refNo}','Rejected')">‚úñ</button>
                    </div>
                </td>` : `<td><span class="pill ${s.toLowerCase()}">${s}</span></td>`}
            </tr>`;

                if (s === "Pending" && p) p.insertAdjacentHTML("beforeend", row);
                if (s === "Accepted" && a) a.insertAdjacentHTML("beforeend", row);
                if (s === "Rejected" && r) r.insertAdjacentHTML("beforeend", row);
            });
        }

        function updateInv(refNo, status) {
            let inv = JSON.parse(localStorage.getItem("lndbInvestments")) || [];
            const idx = inv.findIndex(x => x.refNo === refNo);
            if (idx >= 0) {
                inv[idx].status = status;
                localStorage.setItem("lndbInvestments", JSON.stringify(inv));
                loadInvestments();
                populateQuick();
                showToast(`Investment ${refNo} ${status}`);
            }
        }

        /* ==========================================================
           TAB SWITCHING
        ========================================================== */

        function showAccTab(panel, btn) {
            btn.parentElement.querySelectorAll("button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");

            document.getElementById("accPendingPanel").style.display = panel === "accPending" ? "block" : "none";
            document.getElementById("accAcceptedPanel").style.display = panel === "accAccepted" ? "block" : "none";
            document.getElementById("accRejectedPanel").style.display = panel === "accRejected" ? "block" : "none";
        }

        function showLoanSub(panel) {
            document.getElementById("loanPendingPanel").style.display = panel === "loanPending" ? "block" : "none";
            document.getElementById("loanAcceptedPanel").style.display = panel === "loanAccepted" ? "block" : "none";
            document.getElementById("loanRejectedPanel").style.display = panel === "loanRejected" ? "block" : "none";
        }

        function showCardSub(id, btn) {
            btn.parentElement.querySelectorAll("button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            ["cardPendingPanel", "cardAcceptedPanel", "cardRejectedPanel"].forEach(p => {
                document.getElementById(p).style.display = p === id ? "block" : "none";
            });
        }

        function showInvSub(panel) {
            document.getElementById("invPendingPanel").style.display = panel === "invPending" ? "block" : "none";
            document.getElementById("invAcceptedPanel").style.display = panel === "invAccepted" ? "block" : "none";
            document.getElementById("invRejectedPanel").style.display = panel === "invRejected" ? "block" : "none";
        }

        /* ==========================================================
           SEARCH & LOGOUT
        ========================================================== */

        function searchAll(e) {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll("tbody tr").forEach(tr => {
                tr.style.display = tr.textContent.toLowerCase().includes(q) ? "" : "none";
            });
        }

        function adminLogout() {
            localStorage.removeItem("adminLogin");
            window.location.href = "index.html";
        }

        /* ==========================================================
           INIT
        ========================================================== */

        document.addEventListener("DOMContentLoaded", () => {
            refreshDashboard();
            loadLoans();
            loadCards();
            loadAccounts();
            loadInvestments();
        });
    </script>


</body>

</html>